* Request diteruskan ke Gemini AI System.
   * Agent Numeri mengekstrak data dari gambar menggunakan Gemini 2.5 Flash-Lite (Multimodal).
   * Agent menggabungkan data baru ke dalam array JSON yang ada dengan validasi akuntansi double-entry.
4. Review: Hasil JSON baru ditampilkan di Grid Editor. User bisa melihat baris baru yang ditambahkan AI.
5. Download: User mengklik tombol "Download JSON" untuk menyimpan file numeri_transactions_20251123.json ke komputer.
4. Functional Requirements
ID
	Requirement
	Deskripsi Teknis
	FR-01
	Gemini AI Agent Config
	Agent Gemini 2.5 Flash-Lite dikonfigurasi untuk menerima input teks/gambar dan SELALU mengembalikan full JSON object.
	FR-02
	Secure Proxy
	Middleware Vercel (/api/agent) menangani API Key Google Gemini dan menyembunyikan credential.
	FR-03
	Vision Handling
	Konversi gambar upload ke Base64 di client-side sebelum dikirim ke API.
	FR-04
	Schema Enforcement
	Agent memvalidasi output terhadap skema JSON sebelum dikirim balik ke UI.
	FR-05
	File Upload Handling
	Parsing file .json yang diupload user ke dalam variabel state React (Memory Buffer).
	FR-06
	Download Generation
	Mengubah state React kembali menjadi file .json (URL.createObjectURL) saat user klik Download.
	FR-07
	Stateless Processing
	Server tidak boleh menyimpan file user. Data hanya hidup selama sesi browser aktif.
5. Konfigurasi Agent (Gemini AI System)
Konfigurasi ini memastikan AI mengembalikan file utuh, meminimalisir logika rumit di frontend.

## 5.1 Vision Agent (Gemini 2.5 Flash-Lite)
* Name: Numeri Vision Agent
* Model: Gemini 2.5 Flash-Lite (Multimodal)
* Role: Receipt OCR dan Data Extraction
* Instructions:
Extract receipt data (Date, Merchant, Amount, Items) into strict JSON format. Generate UUID and append to existing array.

## 5.2 Logic Agent (Gemini 2.5 Flash-Lite)
* Name: Numeri Logic Agent
* Model: Gemini 2.5 Flash-Lite
* Role: JSON Manipulation dan Accounting Logic
* Instructions (System Prompt):
You are Numeri, an Expert AI Accountant.

Rules:
1. **Double-Entry:** Translate user intent into strict Journal Entries (Debit/Credit).
2. **Structure:** If user asks to change columns, restructure the JSON schema.
3. **Math:** Calculate balances accurately.
4. **Output:** Return ONLY the valid updated JSON dataset matching the schema.

CURRENT JSON DATASET:
{DYNAMIC_DATA_INJECTION}

User Command: {USER_PROMPT}

Return ONLY this JSON structure (no markdown, no explanations outside JSON):
* Request diteruskan ke Gemini AI System.
   * Agent Numeri mengekstrak data dari gambar menggunakan Gemini 2.5 Flash-Lite (Multimodal).
   * Agent menggabungkan data baru ke dalam array JSON yang ada dengan validasi akuntansi double-entry.
4. Review: Hasil JSON baru ditampilkan di Grid Editor. User bisa melihat baris baru yang ditambahkan AI.
5. Download: User mengklik tombol "Download JSON" untuk menyimpan file numeri_transactions_20251123.json ke komputer.
4. Functional Requirements
ID
	Requirement
	Deskripsi Teknis
	FR-01
	Gemini AI Agent Config
	Agent Gemini 2.5 Flash-Lite dikonfigurasi untuk menerima input teks/gambar dan SELALU mengembalikan full JSON object.
	FR-02
	Secure Proxy
	Middleware Vercel (/api/agent) menangani API Key Google Gemini dan menyembunyikan credential.
	FR-03
	Vision Handling
	Konversi gambar upload ke Base64 di client-side sebelum dikirim ke API.
	FR-04
	Schema Enforcement
	Agent memvalidasi output terhadap skema JSON sebelum dikirim balik ke UI.
	FR-05
	File Upload Handling
	Parsing file .json yang diupload user ke dalam variabel state React (Memory Buffer).
	FR-06
	Download Generation
	Mengubah state React kembali menjadi file .json (URL.createObjectURL) saat user klik Download.
	FR-07
	Stateless Processing
	Server tidak boleh menyimpan file user. Data hanya hidup selama sesi browser aktif.
5. Konfigurasi Agent (Gemini AI System)
Konfigurasi ini memastikan AI mengembalikan file utuh, meminimalisir logika rumit di frontend.

## 5.1 Vision Agent (Gemini 2.5 Flash-Lite)
* Name: Numeri Vision Agent
* Model: Gemini 2.5 Flash-Lite (Multimodal)
* Role: Receipt OCR dan Data Extraction
* Instructions:
Extract receipt data (Date, Merchant, Amount, Items) into strict JSON format. Generate UUID and append to existing array.

## 5.2 Logic Agent (Gemini 2.5 Flash-Lite)
* Name: Numeri Logic Agent
* Model: Gemini 2.5 Flash-Lite
* Role: JSON Manipulation dan Accounting Logic
* Instructions (System Prompt):
You are Numeri, an Expert AI Accountant.

Rules:
1. **Double-Entry:** Translate user intent into strict Journal Entries (Debit/Credit).
2. **Structure:** If user asks to change columns, restructure the JSON schema.
3. **Math:** Calculate balances accurately.
4. **Output:** Return ONLY the valid updated JSON dataset matching the schema.

CURRENT JSON DATASET:
{DYNAMIC_DATA_INJECTION}

User Command: {USER_PROMPT}

Return ONLY this JSON structure (no markdown, no explanations outside JSON):
{
  "filename": "transactions_updated.json",
  "content": [array of updated rows],
  "explanation": "Penjelasan perubahan dalam Bahasa Indonesia"
}

## 5.3 Orchestrate Agent (IBM watsonx Orchestrate)
* Name: Numeri Orchestration Agent (AskOrchestrate & Cross-File)
* Model: IBM watsonx Orchestrate
* Role: **Multi-Purpose Agentic Router (AskOrchestrate)** dan Cross-File Analysis
* Environment Variables:
  - ORCHESTRATE_BASE_URL: IBM watsonx Orchestrate instance URL (Endpoint Embed on your website)
  - ORCHESTRATE_API_KEY: IBM watsonx Orchestrate API Key
  - ORCHESTRATE_AGENT_NAME: IBM watsonx Orchestrate agent name (e.g., AskOrchestrate)
  - ORCHESTRATE_INVOKE_PATH: Path untuk invoke agent (Endpoint Embed)

6. Data Architecture (In-Memory Schemas)
Struktur data yang diharapkan dari upload user dan output AI.
A. transactions.json
[
  {
    "id": "a1b2-c3d4",
    "date": "2023-11-22",
    "description": "IBM Cloud Credits",
    "amount": 1500000,
    "category": "Software",
    "type": "expense"
  }
]

B. custom_schemas.json (Optional Upload)
User bisa mengupload file ini bersamaan untuk memberitahu AI tentang kolom tambahan.
{
  "custom_fields": {
    "transactions": { "tax_deductible": "boolean" }
  }
}

7. Architecture Diagram (Stateless Flow)
graph LR
    subgraph User_Device [User Laptop]
        User((User))
        Browser[Numeri Web App]
        File[JSON/Image File]
    end
    
    subgraph Cloud [Vercel Platform]
        Proxy[Serverless Function]
    end
    
    subgraph Google [Google Cloud]
        GeminiAgent[Gemini AI]
        Gemini[Gemini 2.5 Flash-Lite]
    end
    
    subgraph IBM [IBM Cloud]
        Orchestrate[IBM watsonx Orchestrate]
        CrossFileAgent[NumeriCrossFileAgent]
    end

    User --1. Upload File--> Browser
    Browser --2. Parse to Memory--> Browser
    User --3. Trigger AI (Prompt/Image)--> Browser
    Browser --4. JSON + Image (Base64)--> Proxy
    Proxy --5a. Route to Vision--> GeminiAgent
    Proxy --5b. Route to Cross-File--> Orchestrate
    Proxy --5c. Route to Logic--> GeminiAgent
    GeminiAgent --6a. Inference--> Gemini
    Orchestrate --6b. Processing--> CrossFileAgent
    Gemini --7a. Vision Result--> GeminiAgent
    CrossFileAgent --7b. Cross-File Result--> Orchestrate
    GeminiAgent --8a. Response--> Proxy
    Orchestrate --8b. Response--> Proxy
    Proxy --9. Update State--> Browser
    Browser --10. Render Grid--> User
    User --11. Click Download--> File

8. Deliverables
1. Vercel Project: URL publik yang bisa diakses juri.
2. Source Code: Repository GitHub bersih tanpa API Key.
3. Demo Assets: Contoh file sample_receipt.jpg dan sample_data.json untuk mempermudah pengujian juri.

9. Non-Functional Requirements (NFR)
Security
* Zero-State: Tidak ada database. Jika user refresh halaman, data hilang (kecuali di-download sebelumnya). Ini adalah fitur Keamanan dan Privasi, bukan bug.
* Input Validation: Vercel Proxy membatasi ukuran payload maksimal 4.5MB (batas Serverless Function) untuk mencegah abuse.
Performance
* Client-Side Speed: Parsing JSON dan rendering tabel dilakukan di browser (main thread), sangat cepat untuk file < 1MB.
* Optimistic Updates: UI menampilkan loading spinner "Analyzing Document..." saat menunggu respons Gemini.
Error Handling
Error Case
	System Behavior
	Invalid File Upload
	Jika user upload file non-JSON atau JSON rusak, tampilkan Alert: "Invalid JSON Format". Reset ke grid kosong.
	Vision Fail
	Jika gambar buram, Agent mengembalikan JSON lama tanpa perubahan + explanation: "Image unclear". UI menampilkan pesan toast warning.
	Empty Input
	Jika user menekan "Process" tanpa upload apapun, kirim array kosong [] ke AI sebagai start awal.
	Gemini Timeout
	Jika Gemini memakan waktu > 30 detik (limit Vercel Pro Plan), tampilkan: "Process timed out. Try smaller image."

10. Acceptance Criteria & Success Metrics
Acceptance Criteria (MVP)
1. File Upload: Sistem menerima upload transactions.json valid dan menampilkannya di tabel.
2. Vision-to-Data: User upload gambar struk → Sistem menambah baris baru di tabel dengan nominal yang benar.
3. Chat Modification: User mengetik "Ubah deskripsi transaksi terakhir jadi 'Lunch'" → Data di tabel berubah.
4. Download Integrity: File yang didownload valid JSON dan bisa dibuka kembali oleh aplikasi.
5. No Local Artifacts: Aplikasi tidak meminta izin akses folder (permission prompt) sama sekali.
Success Metrics
1. Demo Smoothness: Presentasi berjalan tanpa error "Permission Denied" atau isu browser compatibility.
2. Accuracy: 3 dari 3 percobaan upload struk menghasilkan angka amount yang tepat.

11. API Contract – Gemini AI Integration
This section defines the mandatory contract between the Vercel Serverless Proxy and the Google Gemini AI deployment. The Vercel function is responsible for pre-processing, authentication (API Key management), and post-processing the final response.

## 11.1 Environment Variables Required
- GEMINI_API_KEY: Google Gemini API key for authentication
- ORCHESTRATE_BASE_URL: IBM watsonx Orchestrate instance URL (Endpoint Embed)
- ORCHESTRATE_API_KEY: IBM watsonx Orchestrate API Key (Digunakan oleh Endpoint Embed)
- ORCHESTRATE_AGENT_NAME: IBM watsonx Orchestrate agent name
- ORCHESTRATE_INVOKE_PATH: Path untuk invoke agent (Endpoint Embed)

## 11.2 Agent Routing Logic
The Vercel Proxy implements **4-way intelligent routing** based on input type and explicit header target:

### 1. AskOrchestrate Tasks (Explicit Target)
- **Trigger**: HTTP Header `X-Target-Agent: 'AskOrchestrate'` is present in request.
- **Priority**: Highest (overrides all other triggers).
- **Model**: IBM watsonx Orchestrate AskOrchestrate Agent
- **Function**: handleOrchestrateTask()
- **Process**: Send user prompt to Orchestrate Embed Endpoint.

### 2. Cross-File Tasks (Multiple Datasets)
- **Trigger**: `dataKeys.length >= 2` (multiple datasets with 'data' in key name) **AND** no explicit header target.
- **Model**: IBM watsonx Orchestrate Numeri Orchestration Agent
- **Function**: handleOrchestrateTask()
- **Process**: Send entire request body to Orchestrate → Multi-dataset analysis → Return structured JSON

### 3. Vision Tasks (Image Processing)
- **Trigger**: `imageBase64` present in request (keys: imageBase64, image, file, attachment) **AND** no explicit header target.
- **Model**: gemini-2.5-flash-lite (multimodal)
- **Function**: handleVisionTask()
- **Process**: Extract receipt data → Generate UUID → Append to JSON array

### 4. Logic Tasks (Text Processing)
- **Trigger**: text prompt only (no image, single dataset) **AND** no explicit header target.
- **Model**: gemini-2.5-flash-lite
- **Function**: handleLogicTask()
- **Process**: Apply accounting rules → Update JSON schema → Return full dataset

## 11.3 Response Format
Both agents return consistent JSON structure:
```javascript
{
  "filename": "transactions_updated.json",
  "content": [updated_transactions_array],
  "explanation": "Penjelasan perubahan dalam Bahasa Indonesia"
}
```

## 11.4 Error Handling
- **API Key Error**: Return "Gemini API unavailable - Check configuration"
- **Orchestrate API Error**: Return "Orchestrate API failed - Check IBM configuration" (Mencakup kegagalan koneksi ke endpoint Embed)
- **AskOrchestrate Fail**: Return original data + "Ask Orchestrate failed to provide a useful answer." explanation
- **Timeout**: Return "Process timed out. Try smaller image."
- **Invalid Input**: Return "Invalid input format. Please check your data."
- **Vision Fail**: Return original data + "Image unclear" explanation
- **Cross-File Fail**: Return original data + "Cross-file analysis failed" explanation